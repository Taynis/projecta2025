//©///////////////////////////////////////////////////////////////////////////©//
//
//  Copyright 2021-2025 BIA-Technologies Limited Liability Company
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
//©///////////////////////////////////////////////////////////////////////////©//

#Область СлужебныйПрограммныйИнтерфейс

// Возвращает структуру с настройками подключения.
//
// Возвращаемое значение:
//   Структура - Настройки подключения:
//     * Сервер - Строка - адрес сервера
//     * Порт - Число - порт сервера
//     * Схема - Строка - схема подключения (http/https)
//     * Ресурс - Строка - путь к ресурсу
//     * Пользователь - Строка - имя пользователя
//     * Пароль - Строка - пароль пользователя
//     * Заголовки - Соответствие из Строка - HTTP-заголовки запроса
//     * Таймаут - Число - время ожидания ответа в секундах
//     * РазрешенныеКодыСостояния - Массив из Число - список разрешенных HTTP-кодов ответа
//     * Прокси - Структура - настройки прокси-сервера
//     * ВыполнятьНаСервере - Булево - признак выполнения запроса на сервере
//     * ЭтаБаза - Булево - признак выполнения запроса к текущей базе
//     * ИспользуетсяСериализация - Булево - признак использования сериализации данных
//
Функция ОписаниеНастройкиПодключения() Экспорт
	
	НастройкиПодключения = Новый Структура;
	НастройкиПодключения.Вставить("Сервер", "");
	НастройкиПодключения.Вставить("Порт", 0);
	НастройкиПодключения.Вставить("Схема", "");
	НастройкиПодключения.Вставить("Ресурс", "");
	НастройкиПодключения.Вставить("Пользователь", "");
	НастройкиПодключения.Вставить("Пароль", "");
	НастройкиПодключения.Вставить("Заголовки", Новый Соответствие);
	НастройкиПодключения.Вставить("Таймаут", 30);
	НастройкиПодключения.Вставить("РазрешенныеКодыСостояния", Новый Массив);
	НастройкиПодключения.Вставить("Прокси", ОписаниеНастроекПрокси());
	НастройкиПодключения.Вставить("ВыполнятьНаСервере", Ложь);
	НастройкиПодключения.Вставить("ЭтаБаза", Ложь);
	НастройкиПодключения.Вставить("ИспользуетсяСериализация", Истина);
	
	КодыОтветов = РатОбщийКлиентСервер.КодыОтветов();
	НастройкиПодключения.РазрешенныеКодыСостояния.Добавить(КодыОтветов.Успешно);
	НастройкиПодключения.РазрешенныеКодыСостояния.Добавить(КодыОтветов.Создано);
	НастройкиПодключения.РазрешенныеКодыСостояния.Добавить(КодыОтветов.Принято);
	
	Возврат НастройкиПодключения;
	
КонецФункции

// Возвращает структуру с настройками прокси-сервера.
//
// Возвращаемое значение:
//   Структура - Настройки прокси:
//     * Использовать - Булево - признак использования прокси
//     * ПроксиПоУмолчанию - Булево - признак использования системных настроек прокси
//     * АутентификацияОС - Булево - признак использования системной аутентификации
//     * Сервер - Строка - адрес прокси-сервера
//     * Порт - Число - порт прокси-сервера
//     * Пользователь - Строка - имя пользователя прокси
//     * Пароль - Строка - пароль пользователя прокси
//
Функция ОписаниеНастроекПрокси() Экспорт
	
	Описание = Новый Структура;
	Описание.Вставить("Использовать", Ложь);
	Описание.Вставить("ПроксиПоУмолчанию", Ложь);
	Описание.Вставить("АутентификацияОС", Ложь);
	Описание.Вставить("Сервер", "");
	Описание.Вставить("Порт", 0);
	Описание.Вставить("Пользователь", "");
	Описание.Вставить("Пароль", "");
	
	Возврат Описание;
	
КонецФункции

// Выполняет HTTP-запрос с заданными параметрами.
//
// Параметры:
//   ОписаниеЗапроса - см. РатВызовСервисаКлиент.ОписаниеЗапроса
//
// Возвращаемое значение:
//   см. РатШагиВанессыКлиентСервер.ДанныеОтвета
//
// Пример:
//   ОписаниеЗапроса = Новый Структура;
//   ОписаниеЗапроса.Вставить("Метод", "GET");
//   ОписаниеЗапроса.Вставить("АдресРесурса", "/api/v1/users");
//   ОписаниеЗапроса.Вставить("НастройкиПодключения", ОписаниеНастройкиПодключения());
//   Ответ = ВыполнитьHttpЗапрос(ОписаниеЗапроса);
//
Функция ВыполнитьHttpЗапрос(ОписаниеЗапроса) Экспорт
	
	НастройкиПодключения = ОписаниеЗапроса.НастройкиПодключения;
	
	ЗапросКЭтойБазе = НастройкиПодключения.ЭтаБаза;
	
#Если Сервер Тогда
	Если ЗапросКЭтойБазе Тогда
		Ответ = ВыполнитьЗапросКЭтойБазе(ОписаниеЗапроса);
	Иначе
		Ответ = РатКоннекторHTTP.ВыполнитьЗапрос(ОписаниеЗапроса);
	КонецЕсли;
#Иначе
	Ответ = РатКоннекторHTTP.ВыполнитьЗапрос(ОписаниеЗапроса);
#КонецЕсли
	
	Если НЕ Ответ.Успешно Тогда
		ВызватьИсключение "Не удалось выполнить http-запрос, проверьте настройки подключения,
						  |Ошибка:
						  |" + РатСтроки.ПредставлениеОшибки(Ответ.Ошибка);
	КонецЕсли;
	
	Возврат Ответ;
	
КонецФункции

// Возвращает структуру с данными ответа HTTP-запроса.
//
// Возвращаемое значение:
//   Структура - Данные ответа:
//     * Успешно - Булево - признак успешного выполнения запроса
//     * КодСостояния - Число - HTTP-код состояния
//     * Заголовки - Соответствие из Строка - HTTP-заголовки ответа
//     * Тело - Строка, Структура, Массив из Произвольный, Неопределено - тело ответа
//     * РасшифровкаКода - Строка - текстовое описание кода ответа
//     * Ошибка - Структура - информация об ошибке (если запрос не выполнен)
//
Функция ДанныеОтвета() Экспорт
	
	ДанныеОтвета = Новый Структура("Успешно", Ложь);
	ДанныеОтвета.Вставить("КодСостояния", 0);
	ДанныеОтвета.Вставить("Заголовки", Новый Соответствие());
	ДанныеОтвета.Вставить("Тело", Неопределено);
	ДанныеОтвета.Вставить("РасшифровкаКода", "Ответ не заполнен");
	ДанныеОтвета.Вставить("Ошибка", Неопределено);
	
	//@skip-check constructor-function-return-section
	Возврат ДанныеОтвета;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выводит информацию о выполняемом HTTP-запросе.
//
// Параметры:
//   ПолныйАдрес - Строка - полный URL запроса
//   ОписаниеЗапроса - см. РатВызовСервисаКлиент.ОписаниеЗапроса
//
Процедура ВывестиЗапрос(ПолныйАдрес, ОписаниеЗапроса) Экспорт
	
	КонтекстВыполнения = ?(ОписаниеЗапроса.НастройкиПодключения.ВыполнятьНаСервере, "На сервере", "На клиенте");
	
	ТелоЭтоСтрока = ТипЗнч(ОписаниеЗапроса.Тело) = Тип("Строка");
	
	Сообщения = Новый Массив;
	Сообщения.Добавить(СтрШаблон("Выполнение запроса: [%1] %2 (%3)", ОписаниеЗапроса.Метод, ПолныйАдрес, КонтекстВыполнения));
	Сообщения.Добавить("Заголовки: " + ЗаголовкиВСтроку(ОписаниеЗапроса.НастройкиПодключения.Заголовки));
	
	Если ТелоЭтоСтрока Тогда
		Сообщения.Добавить("Тело: " + Символы.ПС + Символы.Таб + ОписаниеЗапроса.Тело);
	Иначе
		Сообщения.Добавить("Тело: " + Символы.ПС + Символы.Таб + РатJSON.ОбъектВСтроку(ОписаниеЗапроса.Тело));
	КонецЕсли;
	
	РатОбщийКлиентСервер.СообщитьПользователю(СтрСоединить(Сообщения, Символы.ПС));
	
КонецПроцедуры

// Выводит информацию о полученном ответе HTTP-запроса.
//
// Параметры:
//   Ответ - Структура - данные ответа:
//     * Заголовки - Соответствие из Строка - HTTP-заголовки ответа
//     * Тело - Произвольный - тело ответа
//
Процедура ВывестиОтвет(Ответ) Экспорт
	
	Сообщения = Новый Массив;
	Сообщения.Добавить("Ответ");
	Сообщения.Добавить("Заголовки: " + ЗаголовкиВСтроку(Ответ.Заголовки));
	Сообщения.Добавить("Тело: " + Символы.ПС + Символы.Таб + Ответ.Тело);
	
	РатОбщийКлиентСервер.СообщитьПользователю(СтрСоединить(Сообщения, Символы.ПС));
	
КонецПроцедуры

// Преобразует заголовки HTTP-запроса/ответа в строковое представление.
//
// Параметры:
//   Заголовки - Соответствие из Строка - HTTP-заголовки
//   Шаблон - Строка - шаблон форматирования строки заголовка
//
// Возвращаемое значение:
//   Строка - текстовое представление заголовков
//
Функция ЗаголовкиВСтроку(Заголовки, Шаблон = "%1: %2")
	
	Если НЕ ЗначениеЗаполнено(Заголовки) Тогда
		Возврат "";
	КонецЕсли;
	
	ПредставлениеЗаголовков = Новый Массив;
	
	Для Каждого Элемент Из Заголовки Цикл
		ПредставлениеЗаголовков.Добавить(СтрШаблон(Шаблон, Элемент.Ключ, Элемент.Значение));
	КонецЦикла;
	
	Возврат СтрСоединить(ПредставлениеЗаголовков, Символы.ПС + Символы.Таб);
	
КонецФункции

#Если Сервер Тогда
// Выполняет HTTP-запрос к текущей базе данных.
//
// Параметры:
//   ОписаниеЗапроса - см. РатВызовСервисаКлиент.ОписаниеЗапроса
//
// Возвращаемое значение:
//   см. РатШагиВанессыКлиентСервер.ДанныеОтвета
//
Функция ВыполнитьЗапросКЭтойБазе(ОписаниеЗапроса)
	
	Запрос = Новый Структура;
	Запрос.Вставить("HTTPМетод", ОписаниеЗапроса.Метод);
	Запрос.Вставить("ОтносительныйURL", ОписаниеЗапроса.АдресРесурса);
	Запрос.Вставить("ПараметрыЗапроса", Новый Соответствие());
	Запрос.Вставить("Тело", ОписаниеЗапроса.Тело);
	Запрос.Вставить("ИспользуетсяСериализация", ОписаниеЗапроса.НастройкиПодключения.ИспользуетсяСериализация);
	
	Ответ = РатСервис.ЗапросAPI(Запрос);
	
	Если ТипЗнч(Ответ) <> Тип("Структура") Тогда
		Ответ = РатКоннекторHTTP.ОтветВСтруктуру(Ответ);
	Иначе
		РатКоннекторHTTP.УстановитьРасшифровкуКодаСостояния(Ответ);
	КонецЕсли;
	
	Возврат Ответ;
	
КонецФункции
#КонецЕсли

#КонецОбласти
