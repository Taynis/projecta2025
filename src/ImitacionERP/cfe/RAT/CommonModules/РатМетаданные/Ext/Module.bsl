//©///////////////////////////////////////////////////////////////////////////©//
//
//  Copyright 2021-2025 BIA-Technologies Limited Liability Company
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
//©///////////////////////////////////////////////////////////////////////////©//

#Область ПрограммныйИнтерфейс

// Возвращает метаданные таблицы.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы метаданных (например, "Справочник.Пользователи").
//  СтатусОбработкиЗапроса - см. РатОбщий.НовыйСтатусОбработкиЗапроса
// 
// Возвращаемое значение:
//  Структура - Описание метаданных таблицы:
//   * Реквизиты - Массив из см. РатМетаданные.ОписаниеРеквизита - Описание реквизитов таблицы.
//   * ТабличныеЧасти - Структура - Описание табличных частей:
//       ** Ключ - Строка - Имя табличной части.
//       ** Значение - Структура:
//          *** Реквизиты - Массив из см. РатМетаданные.ОписаниеРеквизита - Описание реквизитов табличной части.
//          *** Представление - Строка - Представление табличной части.
//   * КлючевыеРеквизиты - Массив из Строка - Список ключевых полей таблицы.
//   * Имя - Строка - Имя таблицы (например, "Пользователи").
//   * ИмяТаблицы - Строка - Полное имя таблицы (например, "Справочник.Пользователи").
//   * Представление - Строка - Представление таблицы (например, "Пользователи").
//   * ЭтоРегистр - Булево - Признак, что таблица является регистром.
//
// Пример:
//   СтатусОбработки = РатОбщий.НовыйСтатусОбработкиЗапроса();
//   МетаданныеСправочника = РатМетаданные.МетаданныеТаблицы("Справочник.Пользователи", СтатусОбработки);
Функция МетаданныеТаблицы(ИмяТаблицы, СтатусОбработкиЗапроса) Экспорт
	
	ПараметрыТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	МетаданныеОбъект = ОбъектМетаданных(ПараметрыТаблицы);
	
	ОписаниеМетаданных = Новый Структура;
	ОписаниеМетаданных.Вставить("Реквизиты", Новый Массив);
	ОписаниеМетаданных.Вставить("КлючевыеРеквизиты", Новый Массив());
	
	ОписаниеМетаданных.Вставить("Имя", МетаданныеОбъект.Имя);
	ОписаниеМетаданных.Вставить("ИмяТаблицы", ИмяТаблицы);
	ОписаниеМетаданных.Вставить("Представление", МетаданныеОбъект.Представление());
	
	ОписаниеМетаданных.Реквизиты = ОписаниеРеквизитов(МетаданныеОбъект, ПараметрыТаблицы.Тип);
	
	Если ПараметрыТаблицы.Тип.ТабличныеЧасти Тогда
		
		ОписаниеМетаданных.Вставить("ТабличныеЧасти", Новый Структура());
		КоллекцииРеквизитов = РатКоллекции.ЗначениеВМассиве("Реквизиты", "СтандартныеРеквизиты");
		ОписаниеТипа = Новый Структура("КоллекцииРеквизитов", КоллекцииРеквизитов);
		Для Каждого ТабличнаяЧасть Из МетаданныеОбъект.ТабличныеЧасти Цикл
			
			ОписаниеТабличнойЧасти = Новый Структура("Представление, Реквизиты", ТабличнаяЧасть.Представление());
			ОписаниеТабличнойЧасти.Реквизиты = ОписаниеРеквизитов(ТабличнаяЧасть, ОписаниеТипа);
			ОписаниеМетаданных.ТабличныеЧасти.Вставить(ТабличнаяЧасть.Имя, ОписаниеТабличнойЧасти);
			
		КонецЦикла;
		
	КонецЕсли;
	
	ОписаниеМетаданных.КлючевыеРеквизиты = КлючевыеПоляТаблицы(ИмяТаблицы);
	ОписаниеМетаданных.Вставить("ЭтоРегистр", ЭтоТаблицаРегистра(ИмяТаблицы));
	
	// Информация о таблицах движений
	// Периодичность для регистров
	// Тип таблицы регистра накоплений
	Возврат ОписаниеМетаданных;
	
КонецФункции

// Возвращает объект метаданных по имени таблицы.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы метаданных (например, "Справочник.Пользователи").
//             - см. РатМетаданные.РазложитьИмяТаблицы
//  ВыбрасыватьИсключение - Булево - Выбрасывать исключение, если это не идентификатор объекта метаданных (по умолчанию Истина).
// 
// Возвращаемое значение:
//  ОбъектМетаданных - Объект метаданных 1С.
//  Неопределено - Если объект метаданных не найден и ВыбрасыватьИсключение = Ложь.
//
// Пример:
//   МетаданныеСправочника = РатМетаданные.ОбъектМетаданных("Справочник.Пользователи");
//   // Результат: объект метаданных справочника Пользователи
Функция ОбъектМетаданных(ИмяТаблицы, ВыбрасыватьИсключение = Истина) Экспорт
	
	Если ТипЗнч(ИмяТаблицы) = Тип("Строка") Тогда
		ПараметрыТаблицы = РазложитьИмяТаблицы(ИмяТаблицы, ВыбрасыватьИсключение);
	Иначе
		ПараметрыТаблицы = ИмяТаблицы;
	КонецЕсли;
	
	Если ПараметрыТаблицы = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	КоллекцияМетаданных = Метаданные[ПараметрыТаблицы.Тип.ИмяКоллекции];
	
	Возврат КоллекцияМетаданных[ПараметрыТаблицы.ИмяВида];
	
КонецФункции

// Проверяет возможность редактирования записей в таблице информационной базы.
//
// Параметры:
//  Таблица - Строка - Полное имя таблицы метаданных (например, "Справочник.Пользователи").
//          - см. РатМетаданные.РазложитьИмяТаблицы
// 
// Возвращаемое значение:
//  Булево - Истина, если записи таблицы доступны для редактирования.
//
// Пример:
//   Если РатМетаданные.ДоступноРедактирование("Справочник.Пользователи") Тогда
//       // Редактирование записей справочника доступно
//       // Например, можно создавать, изменять и удалять пользователей
//   КонецЕсли;
Функция ДоступноРедактирование(Знач Таблица) Экспорт
	
	Если ТипЗнч(Таблица) = Тип("Строка") Тогда
		ОписаниеТаблицы = РазложитьИмяТаблицы(Таблица);
	Иначе
		ОписаниеТаблицы = Таблица;
	КонецЕсли;
	
	Возврат ОписаниеТаблицы <> Неопределено И ОписаниеТаблицы.Тип.Редактирование;
	
КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Возвращает описание типов метаданных, используемых при работе расширения.
// Описание загружается из общего макета "РатМетаданные".
//
// Возвращаемое значение:
//  ТаблицаЗначений - Описание типов метаданных:
//   * Имя - Строка - Имя типа метаданных (например, "Справочник", "Документ").
//   * ИмяКоллекции - Строка - Имя типа во множественном числе (например, "Справочники", "Документы").
//   * ОбъектныеДанные - Булево - Признак, что тип описывает объектные данные (имеет ссылку).
//   * Редактирование - Булево - Признак возможности независимого редактирования данных этого типа.
//   * КоллекцииРеквизитов - Массив из Строка - Список коллекций метаданных, которые хранят описание реквизитов 
//                                        (например, "Реквизиты", "СтандартныеРеквизиты", "Измерения").
//   * ТабличныеЧасти - Булево - Признак, что тип метаданных может содержать табличные части.
//   * Предопределенные - Булево - Признак, что тип метаданных может содержать предопределенные элементы.
//   * Поиск - Массив из Строка - Список реквизитов для поиска элементов (например, "Ссылка", "Номер", "Код").
//
// Пример:
//   ОписаниеТипов = РатМетаданные.ТипыМетаданных();
//   Для Каждого Тип Из ОписаниеТипов Цикл
//       Сообщить(Тип.Имя + ": " + Тип.ИмяКоллекции);
//       Если Тип.ОбъектныеДанные Тогда
//           // Обработка объектных типов данных
//           // Например, для справочников и документов
//       КонецЕсли;
//   КонецЦикла;
Функция ТипыМетаданных() Экспорт
	
	ДанныеОписанияМетаданных = РатПреобразования.ЗагрузитьТаблицуMarkDown(ПолучитьОбщийМакет("РатМетаданные"));
	
	ТипБулево = Новый ОписаниеТипов("Булево");
	ТипМассив = Новый ОписаниеТипов("Массив");
	ТипСтрока = Новый ОписаниеТипов("Строка");
	
	Описание = Новый ТаблицаЗначений;
	Описание.Колонки.Добавить("Имя", ТипСтрока);
	Описание.Колонки.Добавить("ИмяКоллекции", ТипСтрока);
	Описание.Колонки.Добавить("ОбъектныеДанные", ТипБулево);
	Описание.Колонки.Добавить("Редактирование", ТипБулево);
	Описание.Колонки.Добавить("КоллекцииРеквизитов", ТипМассив);
	Описание.Колонки.Добавить("ТабличныеЧасти", ТипБулево);
	Описание.Колонки.Добавить("Предопределенные", ТипБулево);
	Описание.Колонки.Добавить("Поиск", ТипМассив);
	
	РеквизитыНачало = 3;
	РеквизитыОкончание = 8;
	
	Для Каждого СырыеДанные Из ДанныеОписанияМетаданных Цикл
		
		СтрокаОписание = Описание.Добавить();
		СтрокаОписание.Имя              = СырыеДанные.Имя;
		СтрокаОписание.ИмяКоллекции     = СырыеДанные.ИмяКоллекции;
		СтрокаОписание.ОбъектныеДанные  = Не ПустаяСтрока(СырыеДанные.Ссылочный);
		СтрокаОписание.ТабличныеЧасти   = Не ПустаяСтрока(СырыеДанные.ТабличныеЧасти);
		СтрокаОписание.Предопределенные = Не ПустаяСтрока(СырыеДанные.Предопределенные);
		СтрокаОписание.Редактирование   = Не ПустаяСтрока(СырыеДанные.Редактирование);
		СтрокаОписание.Поиск            = СтрРазделить(СырыеДанные.Поиск, ", ", Ложь);
		
		Для Колонка = РеквизитыНачало По РеквизитыОкончание Цикл
			Если ПустаяСтрока(СырыеДанные[Колонка]) Тогда
				Продолжить;
			КонецЕсли;
			
			СтрокаОписание.КоллекцииРеквизитов.Добавить(ДанныеОписанияМетаданных.Колонки[Колонка].Имя);
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат Описание;
	
КонецФункции

// Возвращает коллекцию всех реквизитов объекта метаданных.
//
// Параметры:
//  ОбъектМетаданных - ОбъектМетаданных - Объект метаданных, для которого необходимо получить список реквизитов 
//                                  (например, Метаданные.Справочники.Пользователи).
//  ОписаниеТипаМетаданных - СтрокаТаблицыЗначений - см. РатМетаданные.ТипыМетаданных - Описание типа метаданных, 
//                                              полученное из функции ТипыМетаданных().
// 
// Возвращаемое значение:
//  Массив из ОбъектМетаданных - Коллекция реквизитов объекта метаданных (например, реквизит, стандартный реквизит, измерение).
//
// Пример:
//   МетаданныеСправочника = Метаданные.Справочники.Пользователи;
//   ОписаниеТипа = РатМетаданные.ТипМетаданных("Справочник");
//   Реквизиты = РатМетаданные.РеквизитыОбъектаМетаданных(МетаданныеСправочника, ОписаниеТипа);
//   // Результат: массив реквизитов справочника Пользователи
//   Для Каждого Реквизит Из Реквизиты Цикл
//       Сообщить(Реквизит.Имя + ": " + Реквизит.ТипЗначения.Представление());
//   КонецЦикла;
Функция РеквизитыОбъектаМетаданных(ОбъектМетаданных, ОписаниеТипаМетаданных) Экспорт
	
	Реквизиты = Новый Массив;
	
	Для Каждого ИмяКоллекции Из ОписаниеТипаМетаданных.КоллекцииРеквизитов Цикл
		
		Для Каждого Реквизит Из ОбъектМетаданных[ИмяКоллекции] Цикл
			Реквизиты.Добавить(Реквизит);
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат Реквизиты;
	
КонецФункции

// Возвращает описание структуры таблицы информационной базы на основе схемы запроса.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы информационной базы (например, "Справочник.Пользователи").
// 
// Возвращаемое значение:
//  Структура - Описание структуры таблицы:
//   * Реквизиты - Структура - Описание реквизитов таблицы:
//       ** Ключ - Строка - Имя реквизита.
//       ** Значение - ОписаниеТипов - Тип значения реквизита.
//   * ТабличныеЧасти - Структура - Описание табличных частей:
//       ** Ключ - Строка - Имя табличной части.
//       ** Значение - Структура - Описание реквизитов табличной части:
//          *** Ключ - Строка - Имя реквизита табличной части.
//          *** Значение - ОписаниеТипов - Тип значения реквизита.
//
// Пример:
//   СтруктураСправочника = РатМетаданные.СтруктураТаблицы("Справочник.Пользователи");
//   Для Каждого КлючЗначение Из СтруктураСправочника.Реквизиты Цикл
//       Сообщить("Реквизит: " + КлючЗначение.Ключ + ", Тип: " + КлючЗначение.Значение.Представление());
//   КонецЦикла;
Функция СтруктураТаблицы(ИмяТаблицы) Экспорт
	
	Схема = Новый СхемаЗапроса();
	ТекстЗапроса = СтрШаблон("ВЫБРАТЬ * ИЗ %1 КАК _Выборка", ИмяТаблицы); // BSLLS:QueryParseError-off
	Схема.УстановитьТекстЗапроса(ТекстЗапроса);
	Колонки = Схема.ПакетЗапросов[0].Колонки;
	
	Описание = Новый Структура("Реквизиты, ТабличныеЧасти", Новый Структура, Новый Структура);
	
	Для Каждого Колонка Из Колонки Цикл
		
		Если ТипЗнч(Колонка) = Тип("КолонкаСхемыЗапроса") Тогда
			Описание.Реквизиты.Вставить(Колонка.Псевдоним, Колонка.ТипЗначения);
		Иначе
			ОписаниеТЧ = Новый Структура();
			Для Каждого КолонкаТЧ Из Колонка.Колонки Цикл
				ОписаниеТЧ.Вставить(КолонкаТЧ.Псевдоним, КолонкаТЧ.ТипЗначения);
			КонецЦикла;
			Описание.ТабличныеЧасти.Вставить(Колонка.Псевдоним, ОписаниеТЧ);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Описание;
	
КонецФункции

// Возвращает коллекцию имен ключевых полей таблицы информационной базы.
// Ключевые поля однозначно идентифицируют запись в таблице.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы информационной базы (например, "Справочник.Пользователи", "РегистрСведений.КурсыВалют").
// 
// Возвращаемое значение:
//  Массив из Строка - Имена ключевых полей таблицы.
//   + Для объектных данных (справочники, документы и т.д.) - массив из одного элемента "Ссылка".
//   + Для независимых регистров сведений - массив имен измерений и стандартных реквизитов периода.
//   + Для остальных регистров (подчиненных) - массив из двух элементов "Регистратор", "НомерСтроки".
//
// Пример:
//   КлючевыеПоляСправочника = РатМетаданные.КлючевыеПоляТаблицы("Справочник.Номенклатура");
//   // Результат: ["Ссылка"]
//
//   КлючевыеПоляРегистра = РатМетаданные.КлючевыеПоляТаблицы("РегистрСведений.КурсыВалют");
//   // Результат: ["Период", "Валюта"] (или другие измерения, если они есть)
//
//   КлючевыеПоляПодчиненногоРегистра = РатМетаданные.КлючевыеПоляТаблицы("РегистрНакопления.ТоварыОрганизаций");
//   // Результат: ["Регистратор", "НомерСтроки"]
Функция КлючевыеПоляТаблицы(ИмяТаблицы) Экспорт
	
	КлючевыеПоля = Новый Массив;
	
	ОписаниеТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	
	Если ЭтоТаблицаОбъектныхДанных(ОписаниеТаблицы) Тогда
		КлючевыеПоля.Добавить("Ссылка");
		Возврат КлючевыеПоля;
	КонецЕсли;
	
	Если ЭтоТаблицаНезависимогоРегистрСведений(ОписаниеТаблицы) Тогда
		
		КлючевыеПоля = ОтборРегистра(ОписаниеТаблицы);
		
	Иначе
		
		КлючевыеПоля.Добавить("Регистратор");
		КлючевыеПоля.Добавить("НомерСтроки");
		
	КонецЕсли;
	
	Возврат КлючевыеПоля;
	
КонецФункции

Функция ОтборРегистра(ИмяТаблицы) Экспорт
	
	КлючевыеПоля = Новый Массив;
	
	Если ТипЗнч(ИмяТаблицы) = Тип("ОбъектМетаданных") Тогда
		МетаОбъект = ИмяТаблицы;
	ИначеЕсли ТипЗнч(ИмяТаблицы) = Тип("Структура") Тогда
		ОписаниеТаблицы = ИмяТаблицы;
		МетаОбъект = ОбъектМетаданных(ОписаниеТаблицы);
	Иначе // Строка
		ОписаниеТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
		МетаОбъект = ОбъектМетаданных(ОписаниеТаблицы);
	КонецЕсли;
	
	Если ЭтоТаблицаНезависимогоРегистрСведений(ОписаниеТаблицы) Тогда
		
		Для Каждого Реквизит Из МетаОбъект.СтандартныеРеквизиты Цикл
			КлючевыеПоля.Добавить(Реквизит.Имя);
		КонецЦикла;
		
		Для Каждого Реквизит Из МетаОбъект.Измерения Цикл
			КлючевыеПоля.Добавить(Реквизит.Имя);
		КонецЦикла;
		
	Иначе
		
		КлючевыеПоля.Добавить("Регистратор");
		
	КонецЕсли;
	
	Возврат КлючевыеПоля;
	
КонецФункции

// Возвращает описание типа реквизита по полному пути к нему.
// Используется для определения типа значения отбора.
//
// Параметры:
//  Путь - Строка - Полный путь к реквизиту в формате "ИмяТаблицы.ИмяРеквизита[.ИмяРеквизитаСсылки}" 
//                 (например, "Справочник.Пользователи.Наименование" или "Документ.ЗаказКлиента.Товары.Номенклатура").
//                 Для реквизитов ссылочного типа, если нужен тип самой ссылки, то просто "Справочник.Контрагенты.ОсновнойДоговор".
//                 Если нужен тип реквизита объекта по ссылке, то "Справочник.Контрагенты.ОсновнойДоговор.Наименование".
// 
// Возвращаемое значение:
//  ОписаниеТипов - Тип указанного реквизита.
//
// Исключения:
//  Вызывает исключение, если реквизит не найден или если указан путь к табличной части, а не к ее реквизиту.
//
// Пример:
//   ТипНаименования = РатМетаданные.ТипРеквизита("Справочник.Пользователи.Наименование");
//   Сообщить(ТипНаименования.Представление()); // "Строка"
//
//   ТипНоменклатурыВТЧ = РатМетаданные.ТипРеквизита("Документ.РеализацияТоваровУслуг.Товары.Номенклатура");
//   Сообщить(ТипНоменклатурыВТЧ.Представление()); // "СправочникСсылка.Номенклатура"
Функция ТипРеквизита(Путь) Экспорт
	
	НомерВхождения = 2;
	Индекс = СтрНайти(Путь, ".", , , НомерВхождения);
	ИмяТаблицы = Лев(Путь, Индекс);
	Реквизит = Сред(Путь, Индекс + 1);
	
	ТекстЗапроса = СтрШаблон("ВЫБРАТЬ Выборка.%1 ИЗ %2 КАК Выборка", Реквизит, ИмяТаблицы);
	
	Схема = Новый СхемаЗапроса();
	
	Попытка
		
		Схема.УстановитьТекстЗапроса(ТекстЗапроса);
		
	Исключение
		
		ОписаниеОшибки = СтрШаблон("Реквизит '%1' не существует, проверьте правильность запроса", Путь);
		Сообщение = РатОбщийКлиентСервер.ТекстОшибки(ИнформацияОбОшибке(), ОписаниеОшибки);
		ВызватьИсключение Сообщение;
		
	КонецПопытки;
	
	Колонка = Схема.ПакетЗапросов[0].Колонки[0];
	
	ОписаниеТипа = Неопределено;
	
	Если ТипЗнч(Колонка) = Тип("КолонкаВложеннаяТаблицаСхемыЗапроса") Тогда
		Если Колонка.Колонки.Количество() > 1 Тогда
			ВызватьИсключение "Необходимо указывать путь до реквизита, а не до ТЧ";
		КонецЕсли;
		ОписаниеТипа = Колонка.Колонки[0].ТипЗначения;
	Иначе
		ОписаниеТипа = Колонка .ТипЗначения;
	КонецЕсли;
	
	Возврат ОписаниеТипа;

КонецФункции

// Возвращает описание типа метаданных (строку из результата РатМетаданные.ТипыМетаданных()) по имени коллекции или имени типа.
//
// Параметры:
//  ИмяКоллекции - Строка - Имя коллекции метаданных (например, "Справочники", "Документы.ЗаказКлиента") 
//                         или имя типа метаданных (например, "Справочник", "Документ").
// 
// Возвращаемое значение:
//  СтрокаТаблицыЗначений - Строка из таблицы, возвращаемой РатМетаданные.ТипыМетаданных(), соответствующая найденному типу:
// * Имя - Строка - Имя типа метаданных
// * ИмяКоллекции - Строка - Имя типа метаданных во множественном числе
// * ОбъектныеДанные - Булево - Тип метаданных описывает объекты данные
// * Редактирование - Булево - Доступно редактирование объектов относящихся к этому типу
// * КоллекцииРеквизитов - Массив из Строка - Список коллекций (описания метаданных) содержащих реквизиты объектов относящихся к этому типу
// * ТабличныеЧасти - Булево - Признак наличия табличных частей у объектов относящихся к этому типу
// * Предопределенные - Булево - Признак наличия предопределенных элементов у метаданных относящихся к этому типу
// * Поиск - Массив из Строка - Список реквизитов, по которым нужно выполнять поиск объекта, поиск происходит по порядку элементов в списке
//  Неопределено - Если тип метаданных не найден.
//
// Пример:
//   ОписаниеТипаСправочник = РатМетаданные.ТипМетаданных("Справочники");
//   ОписаниеТипаДокумент = РатМетаданные.ТипМетаданных("Документ.ПКО");
Функция ТипМетаданных(ИмяКоллекции) Экспорт
	
	Описание = РатПовтИсп.ТипыМетаданных();
	
	ИмяТипа = СтрРазделить(ИмяКоллекции, ".")[0];
	
	Результат = Описание.Найти(ИмяТипа, "Имя");
	
	Если Результат = Неопределено Тогда
		Результат = Описание.Найти(ИмяТипа, "ИмяКоллекции");
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Возвращает менеджер для таблицы данных.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "Справочник.Пользователи", "Документ.ЗаказКлиента").
//             - см. РатМетаданные.РазложитьИмяТаблицы
//  СтатусОбработкиЗапроса - см. РатОбщий.НовыйСтатусОбработкиЗапроса
// 
// Возвращаемое значение:
//  Произвольный - Менеджер таблицы (например, Справочники.Пользователи, Документы.ЗаказКлиента).
//  Неопределено - Если не удалось получить менеджер и ошибка зафиксирована в СтатусОбработкиЗапроса.
//
// Пример:
//   Статус = РатОбщий.НовыйСтатусОбработкиЗапроса();
//   МенеджерПользователей = РатМетаданные.МенеджерТаблицы("Справочник.Пользователи", Статус);
//   Если МенеджерПользователей <> Неопределено Тогда
//       НовыйПользователь = МенеджерПользователей.СоздатьЭлемент();
//   Иначе
//       РатОбщийКлиентСервер.СообщитьОшибкиПользователю(Статус);
//   КонецЕсли;
Функция МенеджерТаблицы(ИмяТаблицы, СтатусОбработкиЗапроса) Экспорт
	
	Попытка
		
		Возврат Новый (РатТипыДанных.ТипПоИмениТаблицы(ИмяТаблицы, "Менеджер"));
		
	Исключение
		
		ТекстОшибки = СтрШаблон("Не удалось получить менеджер работы с таблицей для ""%1""", ИмяТаблицы);
		КлассОшибки = РатОбщий.КлассыОшибок().АнализПараметровЗапроса;
		РатОбщий.ЗафиксироватьОшибку(СтатусОбработкиЗапроса, КлассОшибки, ТекстОшибки);
		
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Возвращает структуру с таблицами, по которым делает движения указанный документ.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя метаданных документа (например, "Документ.РеализацияТоваровУслуг").
// 
// Возвращаемое значение:
//  Структура - Список таблиц движения:
//      Ключ - Строка - Имя объекта метаданных движения (например, "ТоварыНаСкладах").
//      Значение - Строка - Полное имя объекта метаданных движения (например, "РегистрНакопления.ТоварыНаСкладах").
//
// Пример:
//   ДвиженияДокумента = РатМетаданные.ТаблицыДвижений("Документ.ПоступлениеТоваровУслуг");
//   Для Каждого КлючЗначение Из ДвиженияДокумента Цикл
//       Сообщить("Документ делает движения по регистру: " + КлючЗначение.Значение + " (короткое имя: " + КлючЗначение.Ключ + ")");
//   КонецЦикла;
//   // Пример вывода:
//   // Документ делает движения по регистру: РегистрНакопления.ТоварыНаСкладах (короткое имя: ТоварыНаСкладах)
//   // Документ делает движения по регистру: РегистрБухгалтерии.Хозрасчетный (короткое имя: Хозрасчетный)
Функция ТаблицыДвижений(ИмяТаблицы) Экспорт
	
	Результат = Новый Структура;
	
	ЧастиИмени = СтрРазделить(ИмяТаблицы, ".");
	
	Движения = Метаданные.Документы[ЧастиИмени[1]].Движения;
	
	Для Каждого Объект Из Движения Цикл
		Результат.Вставить(Объект.Имя, Объект.ПолноеИмя());
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Возвращает полное имя таблицы (объекта метаданных) движения по полному имени таблицы документа и короткому имени таблицы движений.
// 
// Параметры:
//  ИмяТаблицыДокумента - Строка - Полное имя таблицы документа (например, "Документ.РеализацияТоваровУслуг").
//  ИмяТаблицыДвижений - Строка - Короткое имя таблицы движений (например, "ТоварыНаСкладах").
// 
// Возвращаемое значение:
//  Строка - Полное имя таблицы движений (например, "РегистрНакопления.ТоварыНаСкладах").
//  Неопределено - Если у документа нет движения с таким коротким именем.
//
// Пример:
//   ПолноеИмяРегистра = РатМетаданные.ПолноеИмяТаблицыДвижений("Документ.ПоступлениеТоваровУслуг", "Закупки");
//   // Результат: "Полное имя регистра 'Закупки': РегистрНакопления.Закупки" (если такой регистр есть)
Функция ПолноеИмяТаблицыДвижений(ИмяТаблицыДокумента, ИмяТаблицыДвижений) Экспорт
	
	Возврат РатКоллекции.ЗначениеСтруктуры(ТаблицыДвижений(ИмяТаблицыДокумента), ИмяТаблицыДвижений);
	
КонецФункции

// Разбирает полное имя таблицы на составляющие и возвращает структуру с описанием.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "Справочник.Пользователи", "РегистрСведений.КурсыВалют").
//  ВыбрасыватьИсключение - Булево - Если Истина (по умолчанию), то при ошибке разбора имени будет вызвано исключение.
//                               Если Ложь, то в случае ошибки функция вернет структуру с Успешно = Ложь и описанием ошибки.
// 
// Возвращаемое значение:
//  Неопределено - При возникновении ошибок и ВыбрасыватьИсключение = Ложь
//  Структура - Описание таблицы:
//   * ИмяТипа - Строка, Неопределено - Тип таблицы (например, "Справочник", "РегистрСведений"). Заполняется, если Успешно = Истина.
//   * ИмяВида - Строка, Неопределено - Вид таблицы (например, "Пользователи", "КурсыВалют"). Заполняется, если Успешно = Истина.
//   * Тип - СтрокаТаблицыЗначений, Неопределено - см. РатМетаданные.ТипМетаданных - Описание типа метаданных, соответствующее ИмяТипа. 
//                                  Заполняется, если Успешно = Истина.
//
// Пример:
//   РезультатРазбора = РатМетаданные.РазложитьИмяТаблицы("Документ.ЗаказПокупателя");
//   Сообщить("Тип: " + РезультатРазбора.ИмяТипа + ", Вид: " + РезультатРазбора.ИмяВида);
//   Сообщить("Имя коллекции: " + РезультатРазбора.Тип.ИмяКоллекции);
Функция РазложитьИмяТаблицы(ИмяТаблицы, ВыбрасыватьИсключение = Истина) Экспорт
	
	ЧастиИмени = СтрРазделить(ИмяТаблицы, ".");
	
	ОжидаемоеКоличествоЧастей = 2;
	
	Если ЧастиИмени.Количество() <> ОжидаемоеКоличествоЧастей Тогда
		Если ВыбрасыватьИсключение Тогда
			Сообщение = СтрШаблон("Не корректное имя таблицы '%1', необходимо указывать полное имя объекта метаданных", ИмяТаблицы);
			ВызватьИсключение Сообщение;
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	ТипМетаданных = ТипМетаданных(ЧастиИмени[0]);
	
	Если ТипМетаданных = Неопределено Тогда
		Если ВыбрасыватьИсключение Тогда
			Сообщение = СтрШаблон("Неизвестный тип метаданных '%1'", ЧастиИмени[0]);
			ВызватьИсключение Сообщение;
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Новый Структура("ИмяТипа, ИмяВида, Тип", ТипМетаданных.Имя, ЧастиИмени[1], ТипМетаданных);
	
КонецФункции

// Проверяет наличие предопределенного элемента с указанным именем в таблице.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "Справочник.Валюты", "Перечисление.ТипыЦенНоменклатуры").
//  ИмяПредопределенного - Строка - Имя предопределенного элемента (например, "USD", "Оптовая").
// 
// Возвращаемое значение:
//  Булево - Истина, если таблица содержит предопределенный элемент с указанным именем, иначе Ложь.
//          Возвращает Ложь также, если тип метаданных таблицы не поддерживает предопределенные элементы.
//
// Пример:
//   Если РатМетаданные.ТаблицаСодержитПредопределенный("Справочник.Валюты", "РУБ") Тогда
//       Сообщить("В справочнике валют есть предопределенная валюта РУБ.");
//   КонецЕсли;
//
//   Если РатМетаданные.ТаблицаСодержитПредопределенный("Перечисление.СтавкиНДС", "НДС10") Тогда
//       Сообщить("Существует предопределенная ставка НДС 10%.");
//   КонецЕсли;
//
//   // Вернет Ложь, т.к. документы не имеют предопределенных элементов
//   ЭтоСодержит = РатМетаданные.ТаблицаСодержитПредопределенный("Документ.ЗаказКлиента", "КакойТоПредопределенный");
Функция ТаблицаСодержитПредопределенный(ИмяТаблицы, ИмяПредопределенного) Экспорт
	
	ПараметрыТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	
	Если НЕ ПараметрыТаблицы.Тип.Предопределенные Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ОбъектМетаданных = ОбъектМетаданных(ПараметрыТаблицы);
	
	Если ОбъектМетаданных.ПолучитьИменаПредопределенных().Найти(ИмяПредопределенного) <> Неопределено Тогда
		Возврат Истина;
	КонецЕсли;
	
	Результат = Ложь;
	
	Для Каждого ИмяЭлемента Из ОбъектМетаданных.ПолучитьИменаПредопределенных() Цикл
		Если СтрСравнить(ИмяЭлемента, ИмяПредопределенного) = 0 Тогда
			Результат = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

#Область ПроверкиТипов

// Проверяет, является ли переданный тип типом ключа записи регистра.
// Ключ записи регистра однозначно идентифицирует запись в регистре.
//
// Параметры:
//  Тип - Тип - Проверяемый тип значения.
// 
// Возвращаемое значение:
//  Булево - Истина, если переданный Тип является типом ключа записи для какого-либо регистра 
//          (сведений, накопления, бухгалтерии или расчета), иначе Ложь.
//
// Пример:
//   ТипКлючаРегистраСведений = Тип("РегистрСведенийКлючЗаписи.КурсыВалют");
//   Если РатМетаданные.ЭтоТипКлючаЗаписи(ТипКлючаРегистраСведений) Тогда
//       Сообщить("Это тип ключа записи регистра сведений.");
//   КонецЕсли;
//
//   ТипСсылкиНаДокумент = Тип("ДокументСсылка.РеализацияТоваровУслуг");
//   Если НЕ РатМетаданные.ЭтоТипКлючаЗаписи(ТипСсылкиНаДокумент) Тогда
//       Сообщить("Ссылка на документ не является типом ключа записи.");
//   КонецЕсли;
Функция ЭтоТипКлючаЗаписи(Тип) Экспорт
	
	Мета = Метаданные.НайтиПоТипу(Тип);
	
	Возврат Мета <> Неопределено
		И (Метаданные.РегистрыСведений.Содержит(Мета)
			ИЛИ Метаданные.РегистрыНакопления.Содержит(Мета)
			ИЛИ Метаданные.РегистрыБухгалтерии.Содержит(Мета)
			ИЛИ Метаданные.РегистрыРасчета.Содержит(Мета))
		И РатТипыДанных.ТипПоИмениТаблицы(Мета.ПолноеИмя(), "КлючЗаписи") = Тип;
	
КонецФункции

// Проверяет, является ли переданный тип типом перечисления.
//
// Параметры:
//  Тип - Тип - Проверяемый тип значения.
// 
// Возвращаемое значение:
//  Булево - Истина, если переданный Тип является ссылкой на значение какого-либо перечисления, иначе Ложь.
//
// Пример:
//   ТипНДС = Тип("ПеречислениеСсылка.СтавкиНДС");
//   Если РатМетаданные.ЭтоТипПеречисления(ТипНДС) Тогда
//       Сообщить("Это тип перечисления (СтавкиНДС).");
//   КонецЕсли;
//
//   ТипСтрока = Тип("Строка");
//   Если НЕ РатМетаданные.ЭтоТипПеречисления(ТипСтрока) Тогда
//       Сообщить("Строка - это не тип перечисления.");
//   КонецЕсли;
Функция ЭтоТипПеречисления(Тип) Экспорт
	
	МетаОбъект = Метаданные.НайтиПоТипу(Тип);
	Возврат МетаОбъект <> Неопределено И Метаданные.Перечисления.Содержит(МетаОбъект);

КонецФункции

// Проверяет, относится ли переданный тип к объектам метаданных типа "Регистр сведений".
// Это может быть ссылка на набор записей, ключ записи или менеджер регистра сведений.
//
// Параметры:
//  Тип - Тип - Проверяемый тип значения.
// 
// Возвращаемое значение:
//  Булево - Истина, если переданный Тип связан с регистром сведений, иначе Ложь.
//
// Пример:
//   ТипНабораЗаписей = Тип("РегистрСведенийНаборЗаписей.АдресныеОбъекты");
//   Если РатМетаданные.ЭтоРегистрСведений(ТипНабораЗаписей) Тогда
//       Сообщить("ТипНабораЗаписей относится к регистру сведений.");
//   КонецЕсли;
//
//   ТипМенеджера = Тип("РегистрСведенийМенеджер.ГрафикиРаботы");
//   Если РатМетаданные.ЭтоРегистрСведений(ТипМенеджера) Тогда
//       Сообщить("ТипМенеджера относится к регистру сведений.");
//   КонецЕсли;
//
//   ТипСправочника = Тип("СправочникСсылка.Номенклатура");
//   Если НЕ РатМетаданные.ЭтоРегистрСведений(ТипСправочника) Тогда
//       Сообщить("ТипСправочника не относится к регистру сведений.");
//   КонецЕсли;
Функция ЭтоРегистрСведений(Тип) Экспорт
	
	МетаОбъект = Метаданные.НайтиПоТипу(Тип);
	Возврат МетаОбъект <> Неопределено И Метаданные.РегистрыСведений.Содержит(МетаОбъект);

КонецФункции

#КонецОбласти

#Область ПроверкиТаблицПоИмени

// Проверяет, содержит ли таблица, указанная по имени, объектные данные.
// Объектные данные - это данные, которые имеют уникальную ссылку (например, справочники, документы).
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "Справочник.Контрагенты", "РегистрСведений.Цены").
// 
// Возвращаемое значение:
//  Булево - Истина, если таблица содержит объектные данные, иначе Ложь.
//          Возвращает Неопределено, если тип метаданных для ИмяТаблицы не найден.
//
// Пример:
//   Если РатМетаданные.ТаблицаСодержитОбъектныеДанные("Справочник.Номенклатура") Тогда
//       Сообщить("Справочник номенклатуры содержит объектные данные."); // Истина
//   КонецЕсли;
//
//   Если НЕ РатМетаданные.ТаблицаСодержитОбъектныеДанные("РегистрСведений.КурсыВалют") Тогда
//       Сообщить("Регистр сведений курсов валют не содержит объектные данные."); // Истина (для этого условия)
//   КонецЕсли;
//
//   Результат = РатМетаданные.ТаблицаСодержитОбъектныеДанные("Перечисление.СтавкиНДС");
//   // Результат будет Ложь
Функция ТаблицаСодержитОбъектныеДанные(ИмяТаблицы) Экспорт
	
	ОписаниеТаблицы = ТипМетаданных(ИмяТаблицы);
	
	Возврат ОписаниеТаблицы <> Неопределено И ОписаниеТаблицы.ОбъектныеДанные;
	
КонецФункции

// Проверяет, является ли таблица, указанная по имени, таблицей перечисления.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "Перечисление.ТипыЦен", "Справочник.Валюты").
// 
// Возвращаемое значение:
//  Булево - Истина, если ИмяТаблицы соответствует перечислению, иначе Ложь.
//
// Пример:
//   Если РатМетаданные.ЭтоТаблицаПеречисления("Перечисление.СтавкиНДС") Тогда
//       Сообщить("Это таблица перечисления СтавкиНДС.");
//   КонецЕсли;
//
//   Если НЕ РатМетаданные.ЭтоТаблицаПеречисления("Справочник.Организации") Тогда
//       Сообщить("Справочник организаций - это не таблица перечисления.");
//   КонецЕсли;
Функция ЭтоТаблицаПеречисления(ИмяТаблицы) Экспорт
	
	ОписаниеТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	
	Возврат СтрСравнить(ОписаниеТаблицы.Тип.Имя, "Перечисление") = 0;
	
КонецФункции

// Проверяет, является ли таблица, указанная по имени, таблицей документа.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "Документ.ЗаказКлиента", "Справочник.Контрагенты").
// 
// Возвращаемое значение:
//  Булево - Истина, если ИмяТаблицы соответствует документу, иначе Ложь.
//
// Пример:
//   Если РатМетаданные.ЭтоТаблицаДокумента("Документ.РеализацияТоваровУслуг") Тогда
//       Сообщить("Это таблица документа РеализацияТоваровУслуг.");
//   КонецЕсли;
//
//   Если НЕ РатМетаданные.ЭтоТаблицаДокумента("Справочник.Номенклатура") Тогда
//       Сообщить("Справочник номенклатуры - это не таблица документа.");
//   КонецЕсли;
Функция ЭтоТаблицаДокумента(ИмяТаблицы) Экспорт
	
	ОписаниеТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	
	Возврат СтрСравнить(ОписаниеТаблицы.Тип.Имя, "Документ") = 0;
	
КонецФункции

// Проверяет, является ли таблица, указанная по имени, таблицей плана обмена.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "ПланОбмена.Полный", "Документ.ПоступлениеТоваров").
// 
// Возвращаемое значение:
//  Булево - Истина, если ИмяТаблицы соответствует плану обмена, иначе Ложь.
//
// Пример:
//   Если РатМетаданные.ЭтоТаблицаПланаОбмена("ПланОбмена.ОбменС Сайтом") Тогда
//       Сообщить("Это таблица плана обмена 'ОбменС Сайтом'.");
//   КонецЕсли;
//
//   Если НЕ РатМетаданные.ЭтоТаблицаПланаОбмена("Справочник.Контрагенты") Тогда
//       Сообщить("Справочник контрагентов - это не таблица плана обмена.");
//   КонецЕсли;
Функция ЭтоТаблицаПланаОбмена(ИмяТаблицы) Экспорт
	
	ОписаниеТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	
	Возврат СтрСравнить(ОписаниеТаблицы.Тип.Имя, "ПланОбмена") = 0;
	
КонецФункции

// Проверяет, является ли таблица, указанная по имени или по структуре описания, таблицей регистра.
// К регистрам относятся: регистры сведений, накопления, бухгалтерии, расчета.
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "РегистрСведений.КурсыВалют", "Документ.ЗаказКлиента").
//             - см. РатМетаданные.РазложитьИмяТаблицы
// 
// Возвращаемое значение:
//  Булево - Истина, если таблица является регистром любого вида, иначе Ложь.
//
// Пример:
//   Если РатМетаданные.ЭтоТаблицаРегистра("РегистрНакопления.ТоварыНаСкладах") Тогда
//       Сообщить("Это таблица регистра.");
//   КонецЕсли;
//
//   ОписаниеТаблицы = РатМетаданные.РазложитьИмяТаблицы("РегистрБухгалтерии.Хозрасчетный");
//   Если ОписаниеТаблицы.Успешно И РатМетаданные.ЭтоТаблицаРегистра(ОписаниеТаблицы) Тогда
//       Сообщить("Это таблица регистра (по описанию).");
//   КонецЕсли;
//
//   Если НЕ РатМетаданные.ЭтоТаблицаРегистра("Справочник.Банки") Тогда
//       Сообщить("Справочник банков - это не таблица регистра.");
//   КонецЕсли;
Функция ЭтоТаблицаРегистра(ИмяТаблицы) Экспорт
	
	Если ТипЗнч(ИмяТаблицы) = Тип("Строка") Тогда
		ОписаниеТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	Иначе
		ОписаниеТаблицы = ИмяТаблицы;
	КонецЕсли;
	
	Возврат СтрНачинаетсяС(ОписаниеТаблицы.Тип.Имя, "Регистр");
	
КонецФункции

// Проверяет, является ли таблица, описанная структурой, независимым регистром сведений.
// Независимый регистр сведений имеет режим записи "Независимый".
//
// Параметры:
//  ИмяТаблицы - Строка - Полное имя таблицы (например, "Справочник.Номенклатура", "РегистрСведений.Цены").
//             - см. РатМетаданные.РазложитьИмяТаблицы
// 
// Возвращаемое значение:
//  Булево - Истина, если таблица является независимым регистром сведений, иначе Ложь.
//          Возвращает Ложь, если ОписаниеТаблицы некорректно или не описывает регистр сведений.
//
// Пример:
//   ОписаниеКурсовВалют = РатМетаданные.РазложитьИмяТаблицы("РегистрСведений.КурсыВалют");
//   Если ОписаниеКурсовВалют.Успешно И РатМетаданные.ЭтоТаблицаНезависимогоРегистрСведений(ОписаниеКурсовВалют) Тогда
//       Сообщить("Регистр КурсыВалют - независимый.");
//   КонецЕсли;
//
//   // Предположим, есть регистр сведений "ИсторияИзмененийРеквизитов", подчиненный регистратору
//   ОписаниеИстории = РатМетаданные.РазложитьИмяТаблицы("РегистрСведений.ИсторияИзмененийРеквизитов");
//   Если ОписаниеИстории.Успешно И НЕ РатМетаданные.ЭтоТаблицаНезависимогоРегистрСведений(ОписаниеИстории) Тогда
//       Сообщить("Регистр ИсторияИзмененийРеквизитов - подчиненный.");
//   КонецЕсли;
Функция ЭтоТаблицаНезависимогоРегистрСведений(ИмяТаблицы) Экспорт
	
	Если ТипЗнч(ИмяТаблицы) = Тип("Строка") Тогда
		ОписаниеТаблицы = РазложитьИмяТаблицы(ИмяТаблицы);
	Иначе
		ОписаниеТаблицы = ИмяТаблицы;
	КонецЕсли;
	
	МетаОбъект = ОбъектМетаданных(ОписаниеТаблицы);
	
	ЭтоРегистрСведений = Метаданные.РегистрыСведений.Содержит(МетаОбъект);
	
	Возврат ЭтоРегистрСведений И МетаОбъект.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.Независимый;
	
КонецФункции

// Проверяет, содержит ли таблица, указанная по имени или по структуре описания, объектные данные.
// Объектные данные - это данные, которые имеют уникальную ссылку (например, справочники, документы, планы видов характеристик и т.д.).
//
// Параметры:
//  Таблица - Строка - Полное имя таблицы (например, "Справочник.Номенклатура", "РегистрСведений.Цены").
//          - см. РатМетаданные.РазложитьИмяТаблицы
// 
// Возвращаемое значение:
//  Булево - Истина, если таблица содержит объектные данные, иначе Ложь.
//          Возвращает Ложь также, если ОписаниеТаблицы = Неопределено (например, для некорректного имени таблицы).
//
// Пример:
//   Если РатМетаданные.ЭтоТаблицаОбъектныхДанных("Документ.ПоступлениеТоваровУслуг") Тогда
//       Сообщить("Документ ПоступлениеТоваровУслуг - это таблица объектных данных.");
//   КонецЕсли;
//
//   ОписаниеРегистра = РатМетаданные.РазложитьИмяТаблицы("РегистрСведений.КурсыВалют");
//   Если ОписаниеРегистра.Успешно И НЕ РатМетаданные.ЭтоТаблицаОбъектныхДанных(ОписаниеРегистра) Тогда
//       Сообщить("Регистр КурсыВалют не является таблицей объектных данных.");
//   КонецЕсли;
//
//   // Пример с некорректным именем (если РазложитьИмяТаблицы вернет ОписаниеТаблицы.Успешно = Ложь, 
//   // то ОписаниеТаблицы.Тип будет Неопределено, и функция вернет Ложь)
//   НеОбъектные = РатМетаданные.ЭтоТаблицаОбъектныхДанных("НеСуществующаяТаблица");
Функция ЭтоТаблицаОбъектныхДанных(Знач Таблица) Экспорт
	
	Если ТипЗнч(Таблица) = Тип("Строка") Тогда
		ОписаниеТаблицы = РазложитьИмяТаблицы(Таблица);
	Иначе
		ОписаниеТаблицы = Таблица;
	КонецЕсли;
	
	Возврат ОписаниеТаблицы <> Неопределено И ОписаниеТаблицы.Тип.ОбъектныеДанные;

КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Возвращает описание реквизитов для указанного объекта метаданных и типа метаданных.
// Используется внутри МетаданныеТаблицы для формирования списка реквизитов основной таблицы и ее табличных частей.
//
// Параметры:
//  ОбъектМетаданных - ОбъектМетаданных - Конкретный объект метаданных (например, справочник, документ, табличная часть, регистр).
//  ОписаниеТипаМетаданных - СтрокаТаблицыЗначений из см. РатМетаданные.ТипыМетаданных()
//                           Определяет, какие коллекции реквизитов (Реквизиты, СтандартныеРеквизиты, Измерения, Ресурсы) будут обработаны.
//
// Возвращаемое значение:
//  Массив из см. РатМетаданные.ОписаниеРеквизита - Массив структур с описанием каждого реквизита.
//
// Пример:
//   // Данная функция обычно вызывается внутри других функций модуля РатМетаданные.
//   // Пример для иллюстрации одного из сценариев вызова (получение реквизитов справочника):
//   МетаданныеСпр = Метаданные.Справочники.Номенклатура;
//   ТипыМД = РатМетаданные.ТипыМетаданных();
//   ОписаниеТипаСпр = ТипыМД.Найти("Справочник", "Имя");
//   Если ОписаниеТипаСпр <> Неопределено Тогда
//       МассивОписанийРеквизитов = РатМетаданные.ОписаниеРеквизитов(МетаданныеСпр, ОписаниеТипаСпр);
//       Для Каждого ОписаниеРеквизита Из МассивОписанийРеквизитов Цикл
//           // ОписаниеРеквизита - это структура, возвращаемая функцией РатМетаданные.ОписаниеРеквизита
//           Сообщить(ОписаниеРеквизита.Имя + " (" + ОписаниеРеквизита.Вид + "): " + ОписаниеРеквизита.Тип);
//       КонецЦикла;
//   КонецЕсли;
//
//   // Пример для табличной части документа:
//   МетаданныеТЧ = Метаданные.Документы.РеализацияТоваровУслуг.ТабличныеЧасти.Товары;
//   // Для табличных частей ОписаниеТипаМетаданных обычно содержит только коллекцию "Реквизиты"
//   ОписаниеТипаДляТЧ = Новый Структура("КоллекцииРеквизитов", РатКоллекции.ЗначениеВМассиве("Реквизиты")); 
//   МассивОписанийРеквизитовТЧ = РатМетаданные.ОписаниеРеквизитов(МетаданныеТЧ, ОписаниеТипаДляТЧ);
//   // ... дальнейшая обработка МассивОписанийРеквизитовТЧ
Функция ОписаниеРеквизитов(ОбъектМетаданных, ОписаниеТипаМетаданных)
	
	Реквизиты = Новый Массив;
	
	Для Каждого ИмяКоллекции Из ОписаниеТипаМетаданных.КоллекцииРеквизитов Цикл
		
		Если ИмяКоллекции = "СтандартныеРеквизиты" Тогда
			ВидРеквизита = "Стандартный";
		ИначеЕсли ИмяКоллекции = "Измерения" Тогда
			ВидРеквизита = "Измерение";
		ИначеЕсли ИмяКоллекции = "Ресурсы" Тогда
			ВидРеквизита = "Ресурс";
		Иначе
			ВидРеквизита = "Реквизит";
		КонецЕсли;
		
		Для Каждого Реквизит Из ОбъектМетаданных[ИмяКоллекции] Цикл
			Реквизиты.Добавить(ОписаниеРеквизита(Реквизит, ВидРеквизита));
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат Реквизиты;
	
КонецФункции

// Формирует структуру с описанием одного реквизита метаданных.
// Используется внутри ОписаниеРеквизитов для получения стандартизированного описания каждого реквизита.
// 
// Параметры:
//  РеквизитМетаданных - ОбъектМетаданныхРеквизит - Конкретный реквизит метаданных. 
//                       Например, стандартный реквизит, измерение, ресурс, обычный реквизит
//  ВидРеквизита - Строка - Вид реквизита ("Стандартный", "Измерение", "Ресурс", "Реквизит").
//
// Возвращаемое значение:
//  Структура - Описание реквизита:
//   * Имя - Строка - Имя реквизита.
//   * Представление - Строка - Представление (синоним) реквизита. Если пустое и имя "НомерСтроки", устанавливается "Номер строки".
//   * Тип - Строка - Представление основного типа данных реквизита. 
//                    Первого в списке типов, если их несколько, например, "Строка", "Число", "СправочникСсылка.Номенклатура"
//   * СоставнойТип - Булево - Истина, если реквизит имеет составной тип данных (более одного типа в ОписанииТипов).
//   * Вид - Строка - Переданное значение параметра ВидРеквизита.
//
// Пример:
//   // Данная функция обычно вызывается внутри РатМетаданные.ОписаниеРеквизитов.
//   // Пример для иллюстрации (получение описания стандартного реквизита "Ссылка"):
//   СтандартныйРеквизитСсылка = Метаданные.Справочники.Номенклатура.СтандартныеРеквизиты.Ссылка;
//   ОписаниеСсылки = РатМетаданные.ОписаниеРеквизита(СтандартныйРеквизитСсылка, "Стандартный");
//   Сообщить("Имя: " + ОписаниеСсылки.Имя +
//   ", Тип: " + ОписаниеСсылки.Тип +
//   ", Составной: " + ОписаниеСсылки.СоставнойТип + 
//   ", Вид: " + ОписаниеСсылки.Вид);	
//   // Вывод: Имя: Ссылка, Тип: СправочникСсылка.Номенклатура, Составной: Ложь, Вид: Стандартный
//
//   // Пример для обычного реквизита "Артикул":
//   РеквизитАртикул = Метаданные.Справочники.Номенклатура.Реквизиты.Артикул;
//   ОписаниеАртикула = РатМетаданные.ОписаниеРеквизита(РеквизитАртикул, "Реквизит");
//   Сообщить(ОписаниеАртикула.Представление + " (" + ОписаниеАртикула.Имя + "): " + ОписаниеАртикула.Тип);
//   // Вывод: Артикул (Артикул): Строка
Функция ОписаниеРеквизита(РеквизитМетаданных, ВидРеквизита)
	Описание = Новый Структура("Имя, Представление", РеквизитМетаданных.Имя, РеквизитМетаданных.Представление());
	
	Описание.Вставить("Тип", РатТипыДанных.ПредставлениеТипа(РеквизитМетаданных.Тип.Типы()[0]));
	Описание.Вставить("СоставнойТип", РеквизитМетаданных.Тип.Типы().Количество() > 1);
	Описание.Вставить("Вид", ВидРеквизита);
	
	Если ПустаяСтрока(Описание.Представление) И Описание.Имя = "НомерСтроки" Тогда
		Описание.Представление = "Номер строки";
	КонецЕсли;
	
	Возврат Описание;
	
КонецФункции

#КонецОбласти
